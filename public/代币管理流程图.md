# 代币管理流程图

## 1. 技术架构图

```mermaid
graph TB
    subgraph "前端层 Frontend"
        A[TokenManager.tsx] --> B[useWallet Hook]
        A --> C[合约配置 contracts.ts]
        A --> D[ABI定义 abis.ts]
        A --> E[样式文件 TokenManager.css]
    end
    
    subgraph "区块链层 Blockchain"
        F[MyDeFiToken.sol] --> G[ERC20标准]
        F --> H[Ownable权限控制]
        F --> I[Mint功能]
        F --> J[Burn功能]
    end
    
    subgraph "Web3交互层"
        K[ethers.js] --> L[Provider]
        K --> M[Signer]
        K --> N[Contract实例]
    end
    
    A --> K
    K --> F
    
    style A fill:#e1f5fe
    style F fill:#f3e5f5
    style K fill:#e8f5e8
```

## 2. 核心组件架构

```mermaid
graph LR
    subgraph "TokenManager组件"
        A[状态管理] --> B[余额显示]
        A --> C[转账功能]
        A --> D[Mint功能]
        A --> E[Burn功能]
        
        B --> F[MDT余额]
        B --> G[USDC余额]
        
        C --> H[转账表单]
        D --> I[Mint表单]
        E --> J[Burn表单]
    end
    
    subgraph "钱包集成"
        K[useWallet Hook] --> L[账户地址]
        K --> M[Provider]
        K --> N[Signer]
    end
    
    A --> K
    
    style A fill:#ffecb3
    style K fill:#c8e6c9
```

## 3. 代币管理详细流程

### 3.1 初始化流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant TM as TokenManager
    participant W as useWallet
    participant P as Provider
    participant C as 合约

    U->>TM: 访问代币管理页面
    TM->>W: 获取钱包状态
    W-->>TM: 返回 {provider, signer, account}
    
    alt 钱包已连接
        TM->>P: 检查网络连接
        TM->>C: 创建合约实例
        TM->>C: 调用 balanceOf(account)
        C-->>TM: 返回代币余额
        TM->>TM: 更新UI显示
    else 钱包未连接
        TM->>TM: 显示默认余额 "0"
    end
```

### 3.2 余额查询流程

```mermaid
flowchart TD
    A[触发余额查询] --> B{检查Provider和Account}
    B -->|存在| C[创建合约实例]
    B -->|不存在| D[设置默认余额 0]
    
    C --> E[并行查询余额]
    E --> F[MyDeFiToken.balanceOf]
    E --> G[MockUSDC.balanceOf]
    
    F --> H[格式化MDT余额]
    G --> I[格式化USDC余额]
    
    H --> J[更新UI状态]
    I --> J
    
    J --> K[显示余额卡片]
    
    style A fill:#e3f2fd
    style K fill:#e8f5e8
```

### 3.3 转账流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant TM as TokenManager
    participant C as MyDeFiToken合约
    participant B as 区块链

    U->>TM: 输入转账信息 (地址, 数量)
    U->>TM: 点击转账按钮
    
    TM->>TM: 验证输入参数
    TM->>TM: 设置loading状态
    
    TM->>C: 调用 transfer(to, amount)
    C->>B: 发送交易到区块链
    B-->>C: 返回交易哈希
    C-->>TM: 返回交易对象
    
    TM->>TM: 等待交易确认 tx.wait()
    TM->>TM: 显示成功提示
    TM->>TM: 清空表单
    TM->>TM: 刷新余额
    TM->>TM: 取消loading状态
    
    Note over TM,B: 错误处理：捕获异常并显示错误信息
```

### 3.4 Mint流程

```mermaid
flowchart TD
    A[用户输入Mint数量] --> B[点击Mint按钮]
    B --> C{验证权限}
    C -->|是Owner| D[创建合约实例]
    C -->|非Owner| E[显示权限错误]
    
    D --> F[调用 'mint' 方法]
    F --> G[发送交易]
    G --> H{交易状态}
    
    H -->|成功| I[等待确认]
    H -->|失败| J[显示错误信息]
    
    I --> K[显示成功提示]
    K --> L[清空表单]
    L --> M[刷新余额]
    
    style A fill:#e8f5e8
    style K fill:#c8e6c9
    style E fill:#ffcdd2
    style J fill:#ffcdd2
```

### 3.5 Burn流程

```mermaid
flowchart TD
    A[用户输入Burn数量] --> B[点击Burn按钮]
    B --> C{验证余额}
    C -->|余额充足| D[创建合约实例]
    C -->|余额不足| E[显示余额不足错误]
    
    D --> F[调用 burn 方法]
    F --> G[发送交易]
    G --> H{交易状态}
    
    H -->|成功| I[等待确认]
    H -->|失败| J[显示错误信息]
    
    I --> K[显示成功提示]
    K --> L[清空表单]
    L --> M[刷新余额]
    
    style A fill:#fff3e0
    style K fill:#ffcc02
    style E fill:#ffcdd2
    style J fill:#ffcdd2
```

## 4. 核心代码结构

### 4.1 状态管理

```typescript
// TokenManager.tsx 核心状态
const [tokenBalance, setTokenBalance] = useState('0');     // MDT余额
const [usdcBalance, setUsdcBalance] = useState('0');       // USDC余额
const [transferAmount, setTransferAmount] = useState('');   // 转账数量
const [transferTo, setTransferTo] = useState('');          // 转账地址
const [mintAmount, setMintAmount] = useState('');          // Mint数量
const [burnAmount, setBurnAmount] = useState('');          // Burn数量
const [loading, setLoading] = useState(false);             // 加载状态
```

### 4.2 合约交互模式

```mermaid
graph LR
    A[用户操作] --> B[参数验证]
    B --> C[设置Loading]
    C --> D[创建合约实例]
    D --> E[调用合约方法]
    E --> F[等待交易确认]
    F --> G[更新UI状态]
    G --> H[刷新数据]
    
    E --> I[错误处理]
    I --> J[显示错误信息]
    J --> K[取消Loading]
    
    style A fill:#e3f2fd
    style G fill:#e8f5e8
    style I fill:#ffcdd2
```

### 4.3 智能合约功能

```solidity
// MyDeFiToken.sol 核心功能
contract MyDeFiToken is ERC20, Ownable {
    // 标准ERC20功能
    function transfer(address to, uint256 amount) returns (bool)
    function balanceOf(address account) view returns (uint256)
    
    // 扩展功能
    function mint(address to, uint256 amount) public onlyOwner  // 仅Owner
    function burn(uint256 amount) public                        // 任何用户
}
```

## 5. 错误处理机制

```mermaid
flowchart TD
    A[用户操作] --> B{输入验证}
    B -->|验证失败| C[显示输入错误]
    B -->|验证通过| D[执行合约调用]
    
    D --> E{网络连接}
    E -->|连接失败| F[使用本地Provider]
    E -->|连接成功| G[使用当前Provider]
    
    F --> H[合约交互]
    G --> H
    
    H --> I{交易状态}
    I -->|成功| J[更新UI]
    I -->|失败| K[捕获错误]
    
    K --> L[解析错误类型]
    L --> M[显示用户友好错误信息]
    
    style C fill:#ffcdd2
    style F fill:#fff3e0
    style K fill:#ffcdd2
    style M fill:#ffcdd2
```

## 6. 用户体验优化

### 6.1 加载状态管理

```mermaid
stateDiagram-v2
    [*] --> 空闲状态
    空闲状态 --> 加载中: 用户操作
    加载中 --> 成功状态: 交易成功
    加载中 --> 错误状态: 交易失败
    成功状态 --> 空闲状态: 3秒后自动
    错误状态 --> 空闲状态: 用户确认
    
    note right of 加载中
        - 禁用按钮
        - 显示加载动画
        - 显示"处理中..."
    end note
    
    note right of 成功状态
        - 显示成功提示
        - 刷新余额
        - 清空表单
    end note
```

### 6.2 数据格式化

```typescript
// 余额显示格式化
parseFloat(tokenBalance).toFixed(4) + ' MDT'

// 数量输入转换
parseEther(transferAmount)  // 用户输入 -> Wei
formatEther(balance)        // Wei -> 用户显示
```

## 7. 安全考虑

### 7.1 权限控制

```mermaid
graph TD
    A[Mint操作] --> B{检查Owner权限}
    B -->|是Owner| C[允许Mint]
    B -->|非Owner| D[拒绝操作]
    
    E[Burn操作] --> F{检查余额}
    F -->|余额充足| G[允许Burn]
    F -->|余额不足| H[拒绝操作]
    
    I[Transfer操作] --> J{检查余额和地址}
    J -->|验证通过| K[允许转账]
    J -->|验证失败| L[拒绝操作]
    
    style C fill:#c8e6c9
    style G fill:#c8e6c9
    style K fill:#c8e6c9
    style D fill:#ffcdd2
    style H fill:#ffcdd2
    style L fill:#ffcdd2
```

### 7.2 输入验证

```typescript
// 前端验证
if (!signer || !transferAmount || !transferTo) return;

// 地址格式验证
ethers.isAddress(transferTo)

// 数量验证
parseFloat(amount) > 0 && parseFloat(amount) <= parseFloat(balance)
```

## 8. 扩展性设计

### 8.1 模块化架构

```mermaid
graph TB
    subgraph "核心模块"
        A[TokenManager] --> B[余额管理]
        A --> C[转账管理]
        A --> D[Mint管理]
        A --> E[Burn管理]
    end
    
    subgraph "工具模块"
        F[providerUtils] --> G[合约调用]
        F --> H[错误处理]
        F --> I[格式化工具]
    end
    
    subgraph "配置模块"
        J[contracts.ts] --> K[合约地址]
        L[abis.ts] --> M[合约ABI]
        N[constants.ts] --> O[常量配置]
    end
    
    A --> F
    A --> J
    A --> L
    A --> N
    
    style A fill:#e1f5fe
    style F fill:#e8f5e8
    style J fill:#fff3e0
```

### 8.2 功能扩展点

1. **多代币支持**: 扩展支持更多ERC20代币
2. **批量操作**: 支持批量转账、批量Mint
3. **交易历史**: 记录和显示交易历史
4. **高级功能**: 支持授权(approve)、委托转账等
5. **价格显示**: 集成价格预言机显示代币价值

## 9. 技术特点总结

### 9.1 前端特点
- **React Hooks**: 使用useState、useEffect管理状态
- **TypeScript**: 类型安全的开发体验
- **ethers.js**: 现代化的Web3交互库
- **响应式设计**: 适配不同屏幕尺寸
- **错误边界**: 完善的错误处理机制

### 9.2 合约特点
- **标准兼容**: 完全兼容ERC20标准
- **权限控制**: 使用OpenZeppelin的Ownable
- **安全性**: 内置溢出保护和权限检查
- **可扩展**: 支持Mint和Burn功能
- **事件日志**: 完整的事件记录

### 9.3 架构特点
- **模块化**: 清晰的模块划分
- **可维护**: 代码结构清晰，易于维护
- **可测试**: 支持单元测试和集成测试
- **可扩展**: 易于添加新功能
- **用户友好**: 直观的用户界面和交互体验

