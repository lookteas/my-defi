# 钱包连接流程图

## 概述

本文档详细描述了Web3 DeFi Protocol项目中钱包连接的完整流程，包括技术架构、核心组件和用户交互流程。

## 技术架构图

```mermaid
graph TB
    A[用户访问应用] --> B{检查MetaMask}
    B -->|已安装| C[检查连接状态]
    B -->|未安装| D[提示安装MetaMask]
    
    C --> E{已连接?}
    E -->|是| F[自动恢复连接]
    E -->|否| G[显示连接按钮]
    
    G --> H[用户点击连接]
    H --> I[请求账户授权]
    I --> J{授权成功?}
    J -->|否| K[显示错误信息]
    J -->|是| L[检查网络]
    
    L --> M{网络正确?}
    M -->|是| N[连接成功]
    M -->|否| O[尝试切换网络]
    
    O --> P{切换成功?}
    P -->|是| N
    P -->|否| Q[尝试添加网络]
    
    Q --> R{添加成功?}
    R -->|是| N
    R -->|否| S[显示网络错误]
    
    F --> N
    N --> T[更新应用状态]
    T --> U[显示DeFi功能]
```

## 核心组件架构

```mermaid
graph LR
    A[App.tsx] --> B[WalletConnection.tsx]
    A --> C[useWallet Hook]
    B --> C
    C --> D[ethers.js Provider]
    C --> E[MetaMask API]
    C --> F[网络配置]
    
    G[TokenManager] --> C
    H[LendingInterface] --> C
    I[DEXInterface] --> C
    J[YieldFarmInterface] --> C
```

## 详细流程说明

### 1. 初始化阶段

```mermaid
sequenceDiagram
    participant U as 用户
    participant A as App组件
    participant W as useWallet Hook
    participant M as MetaMask
    
    U->>A: 访问应用
    A->>W: 初始化Hook
    W->>M: 检查window.ethereum
    M-->>W: 返回ethereum对象
    W->>M: 获取账户列表
    M-->>W: 返回账户信息
    W->>A: 更新连接状态
    A->>U: 显示界面
```

### 2. 连接流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as WalletConnection
    participant W as useWallet Hook
    participant M as MetaMask
    participant N as 网络配置
    
    U->>UI: 点击连接钱包
    UI->>W: 调用connectWallet()
    W->>M: eth_requestAccounts
    M->>U: 显示授权弹窗
    U->>M: 确认授权
    M-->>W: 返回账户地址
    
    W->>M: 获取网络信息
    M-->>W: 返回chainId
    W->>N: 检查网络配置
    
    alt 网络不匹配
        W->>M: wallet_switchEthereumChain
        alt 网络不存在
            W->>M: wallet_addEthereumChain
        end
    end
    
    W->>UI: 更新连接状态
    UI->>U: 显示连接成功
```

### 3. 状态管理流程

```mermaid
stateDiagram-v2
    [*] --> 未连接
    未连接 --> 连接中: 用户点击连接
    连接中 --> 已连接: 授权成功
    连接中 --> 未连接: 授权失败
    已连接 --> 未连接: 用户断开连接
    已连接 --> 未连接: 账户变更
    已连接 --> 已连接: 网络变更
    
    state 已连接 {
        [*] --> 网络检查
        网络检查 --> 网络正确
        网络检查 --> 网络切换
        网络切换 --> 网络正确
        网络正确 --> [*]
    }
```

## 核心代码结构

### 1. useWallet Hook 结构

```typescript
// 状态接口
interface WalletState {
  account: string | null;           // 用户账户
  provider: BrowserProvider | null; // ethers Provider
  signer: ethers.Signer | null;    // 签名器
  isConnected: boolean;            // 连接状态
  isConnecting: boolean;           // 连接中状态
  chainId: number | null;          // 网络ID
}

// 核心功能
const useWallet = () => {
  // 状态管理
  const [walletState, setWalletState] = useState<WalletState>()
  
  // 核心方法
  const checkConnection = useCallback()     // 检查连接
  const connectWallet = useCallback()       // 连接钱包
  const disconnectWallet = useCallback()    // 断开连接
  
  // 事件监听
  useEffect(() => {
    window.ethereum.on('accountsChanged')  // 账户变更
    window.ethereum.on('chainChanged')     // 网络变更
  })
}
```

### 2. 组件层次结构

```
App.tsx
├── WalletConnection.tsx (钱包连接UI)
├── TokenManager.tsx (代币管理)
├── LendingInterface.tsx (借贷界面)
├── DEXInterface.tsx (DEX交易)
└── YieldFarmInterface.tsx (流动性挖矿)

Hooks:
└── useWallet.ts (钱包状态管理)

Config:
├── contracts.ts (合约配置)
└── constants.ts (常量配置)
```

## 网络配置流程

```mermaid
graph TD
    A[检查当前网络] --> B{chainId匹配?}
    B -->|是| C[连接成功]
    B -->|否| D[尝试切换网络]
    
    D --> E{切换成功?}
    E -->|是| C
    E -->|否| F{错误码4902?}
    
    F -->|是| G[网络不存在]
    F -->|否| H[其他错误]
    
    G --> I[添加新网络]
    I --> J{添加成功?}
    J -->|是| C
    J -->|否| K[显示错误]
    
    H --> K
```

## 错误处理机制

### 常见错误类型

1. **MetaMask未安装**
   - 检测：`typeof window.ethereum === 'undefined'`
   - 处理：提示用户安装MetaMask

2. **用户拒绝授权**
   - 检测：`accounts.length === 0`
   - 处理：显示授权失败信息

3. **网络不匹配**
   - 检测：`network.chainId !== NETWORK_CONFIG.chainId`
   - 处理：自动切换或添加网络

4. **网络切换失败**
   - 检测：`switchError.code === 4902`
   - 处理：尝试添加网络配置

## 事件监听机制

```mermaid
graph LR
    A[MetaMask事件] --> B[accountsChanged]
    A --> C[chainChanged]
    
    B --> D[检查账户数量]
    D --> E{账户为空?}
    E -->|是| F[断开连接]
    E -->|否| G[重新检查连接]
    
    C --> H[重新检查连接]
    H --> I[更新网络状态]
```

## 用户体验优化

### 1. 加载状态管理
- `isConnecting`: 显示连接中状态
- 禁用按钮防止重复点击
- 提供视觉反馈

### 2. 地址格式化
```typescript
const formatAddress = (address: string) => {
  return `${address.slice(0, 6)}...${address.slice(-4)}`;
}
```

### 3. 网络显示
- 显示当前网络名称
- 网络状态指示器
- 自动网络切换

## 安全考虑

1. **类型安全**：完整的TypeScript类型定义
2. **错误边界**：完善的错误捕获和处理
3. **状态验证**：连接状态的多重验证
4. **事件清理**：组件卸载时清理事件监听器

## 扩展性设计

### 支持多钱包
```typescript
// 未来可扩展支持
const SUPPORTED_WALLETS = {
  METAMASK: 'MetaMask',
  COINBASE: 'Coinbase Wallet',
  WALLETCONNECT: 'WalletConnect'
}
```

### 多网络支持
```typescript
const NETWORKS = {
  MAINNET: { chainId: 1, name: 'Ethereum Mainnet' },
  SEPOLIA: { chainId: 11155111, name: 'Sepolia Testnet' },
  LOCALHOST: { chainId: 31337, name: 'Hardhat Local' }
}
```

## 总结

钱包连接系统是整个DeFi应用的基础设施，通过：

- **模块化设计**：Hook + 组件分离
- **状态管理**：集中式钱包状态
- **错误处理**：完善的异常捕获
- **用户体验**：流畅的交互流程
- **网络适配**：自动网络检测和切换

为用户提供了稳定、安全、易用的Web3连接体验。