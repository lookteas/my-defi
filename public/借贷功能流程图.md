# 借贷功能流程图

## 1. 技术架构图

```mermaid
graph TB
    subgraph "前端层"
        A[LendingInterface.tsx] --> B[useWallet Hook]
        A --> C[ethers.js]
        A --> D[合约 ABI]
    end
    
    subgraph "Web3 交互层"
        C --> E[Provider/Signer]
        E --> F[合约实例]
    end
    
    subgraph "智能合约层"
        F --> G[LendingPool.sol]
        G --> H[MyDeFiToken.sol]
    end
    
    subgraph "状态管理"
        I[用户存款余额]
        J[用户借款余额]
        K[USDC 余额]
        L[利率信息]
    end
    
    A --> I
    A --> J
    A --> K
    A --> L
```

## 2. 核心组件架构

```mermaid
graph LR
    subgraph "LendingInterface 组件"
        A[状态管理] --> B[数据获取]
        B --> C[用户操作]
        C --> D[UI 渲染]
    end
    
    subgraph "智能合约"
        E[LendingPool] --> F[存款功能]
        E --> G[借款功能]
        E --> H[提款功能]
        E --> I[还款功能]
    end
    
    subgraph "安全机制"
        J[重入保护]
        K[暂停机制]
        L[抵押率检查]
        M[权限控制]
    end
    
    C --> E
    E --> J
    E --> K
    E --> L
    E --> M
```

## 3. 借贷功能详细流程

### 3.1 初始化流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant L as LendingInterface
    participant W as useWallet
    participant C as LendingPool合约
    participant T as MyDeFiToken合约
    
    U->>L: 访问借贷页面
    L->>W: 获取钱包连接状态
    W-->>L: 返回账户信息
    L->>C: 获取用户借贷信息
    C-->>L: 返回存款/借款余额
    L->>T: 获取USDC余额
    T-->>L: 返回余额信息
    L->>C: 获取利率信息
    C-->>L: 返回当前利率
    L-->>U: 显示借贷概览
```

### 3.2 存款流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant L as LendingInterface
    participant T as MyDeFiToken合约
    participant C as LendingPool合约
    
    U->>L: 输入存款金额
    L->>L: 验证输入有效性
    L->>T: 检查代币余额
    T-->>L: 返回余额信息
    L->>T: 调用 approve() 授权
    T-->>L: 授权成功
    L->>C: 调用 supply() 存款
    C->>T: 转移代币到合约
    C->>C: 更新用户存款记录
    C-->>L: 存款成功
    L->>L: 刷新用户信息
    L-->>U: 显示成功消息
```

### 3.3 借款流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant L as LendingInterface
    participant C as LendingPool合约
    participant T as MyDeFiToken合约
    
    U->>L: 输入借款金额
    L->>L: 验证输入有效性
    L->>C: 调用 borrow() 借款
    C->>C: 检查抵押率
    alt 抵押率足够
        C->>T: 从合约转移代币给用户
        C->>C: 更新用户借款记录
        C-->>L: 借款成功
        L->>L: 刷新用户信息
        L-->>U: 显示成功消息
    else 抵押率不足
        C-->>L: 抛出错误
        L-->>U: 显示错误消息
    end
```

### 3.4 还款流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant L as LendingInterface
    participant T as MyDeFiToken合约
    participant C as LendingPool合约
    
    U->>L: 输入还款金额
    L->>L: 验证输入有效性
    L->>T: 检查代币余额
    T-->>L: 返回余额信息
    L->>T: 调用 approve() 授权
    T-->>L: 授权成功
    L->>C: 调用 repay() 还款
    C->>T: 转移代币到合约
    C->>C: 更新用户借款记录
    C-->>L: 还款成功
    L->>L: 刷新用户信息
    L-->>U: 显示成功消息
```

### 3.5 提款流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant L as LendingInterface
    participant C as LendingPool合约
    participant T as MyDeFiToken合约
    
    U->>L: 输入提款金额
    L->>L: 验证输入有效性
    L->>C: 调用 withdraw() 提款
    C->>C: 检查可提款金额
    alt 可提款金额足够
        C->>T: 从合约转移代币给用户
        C->>C: 更新用户存款记录
        C-->>L: 提款成功
        L->>L: 刷新用户信息
        L-->>U: 显示成功消息
    else 可提款金额不足
        C-->>L: 抛出错误
        L-->>U: 显示错误消息
    end
```

## 4. 核心代码结构

### 4.1 前端组件结构

```typescript
// LendingInterface.tsx 核心结构
interface LendingInterface {
  // 状态管理
  userSupplied: string;
  userBorrowed: string;
  usdcBalance: string;
  interestRate: string;
  
  // 核心功能
  fetchLendingInfo(): Promise<void>;
  handleSupply(amount: string): Promise<void>;
  handleBorrow(amount: string): Promise<void>;
  handleRepay(amount: string): Promise<void>;
  handleWithdraw(amount: string): Promise<void>;
  
  // UI 渲染
  renderOverview(): JSX.Element;
  renderActions(): JSX.Element;
}
```

### 4.2 智能合约结构

```solidity
// LendingPool.sol 核心结构
contract LendingPool {
    // 状态变量
    IERC20 public token;
    uint256 public totalSupplied;
    uint256 public totalBorrowed;
    uint256 public interestRate;
    uint256 public collateralRatio;
    
    // 用户信息
    mapping(address => UserInfo) public userInfo;
    
    // 核心功能
    function supply(uint256 amount) external;
    function withdraw(uint256 amount) external;
    function borrow(uint256 amount) external;
    function repay(uint256 amount) external;
    
    // 辅助功能
    function getAvailableToWithdraw(address user) external view returns (uint256);
    function getUserInfo(address user) external view returns (UserInfo memory);
}
```

## 5. 状态管理机制

```mermaid
stateDiagram-v2
    [*] --> 未连接钱包
    未连接钱包 --> 已连接钱包: 连接钱包
    已连接钱包 --> 加载中: 获取借贷信息
    加载中 --> 显示概览: 数据加载完成
    显示概览 --> 存款中: 用户存款
    显示概览 --> 借款中: 用户借款
    显示概览 --> 还款中: 用户还款
    显示概览 --> 提款中: 用户提款
    存款中 --> 显示概览: 存款完成
    借款中 --> 显示概览: 借款完成
    还款中 --> 显示概览: 还款完成
    提款中 --> 显示概览: 提款完成
    存款中 --> 显示概览: 存款失败
    借款中 --> 显示概览: 借款失败
    还款中 --> 显示概览: 还款失败
    提款中 --> 显示概览: 提款失败
```

## 6. 错误处理机制

```mermaid
graph TD
    A[用户操作] --> B{输入验证}
    B -->|无效| C[显示输入错误]
    B -->|有效| D{钱包连接检查}
    D -->|未连接| E[提示连接钱包]
    D -->|已连接| F{余额检查}
    F -->|余额不足| G[显示余额不足]
    F -->|余额充足| H{合约调用}
    H -->|成功| I[更新UI状态]
    H -->|失败| J{错误类型判断}
    J -->|授权失败| K[提示重新授权]
    J -->|抵押率不足| L[显示抵押率错误]
    J -->|其他错误| M[显示通用错误]
    
    C --> N[用户重新输入]
    E --> O[用户连接钱包]
    G --> P[用户充值或减少金额]
    K --> Q[用户重新授权]
    L --> R[用户调整借款金额]
    M --> S[用户重试操作]
```

## 7. 安全机制

### 7.1 智能合约安全

```mermaid
graph LR
    subgraph "安全机制"
        A[ReentrancyGuard] --> B[防重入攻击]
        C[Pausable] --> D[紧急暂停]
        E[Ownable] --> F[权限控制]
        G[抵押率检查] --> H[防过度借款]
    end
    
    subgraph "验证机制"
        I[输入验证]
        J[余额检查]
        K[授权验证]
        L[状态检查]
    end
    
    B --> I
    D --> J
    F --> K
    H --> L
```

### 7.2 前端安全

```typescript
// 安全检查示例
const safeContractCall = async (contractMethod: () => Promise<any>) => {
  try {
    // 检查钱包连接
    if (!account) throw new Error('钱包未连接');
    
    // 检查网络
    if (!isCorrectNetwork) throw new Error('网络错误');
    
    // 执行合约调用
    const result = await contractMethod();
    return result;
  } catch (error) {
    console.error('合约调用失败:', error);
    throw error;
  }
};
```

## 8. 用户体验优化

### 8.1 加载状态管理

```mermaid
graph TD
    A[用户操作] --> B[显示加载状态]
    B --> C[执行合约调用]
    C --> D{操作结果}
    D -->|成功| E[隐藏加载状态]
    D -->|失败| F[隐藏加载状态]
    E --> G[显示成功消息]
    F --> H[显示错误消息]
    G --> I[刷新数据]
    H --> J[保持当前状态]
```

### 8.2 数据格式化

```typescript
// 数据格式化示例
const formatBalance = (balance: string): string => {
  const num = parseFloat(balance);
  if (num === 0) return '0';
  if (num < 0.01) return '< 0.01';
  return num.toFixed(2);
};

const formatPercentage = (rate: string): string => {
  const num = parseFloat(rate);
  return `${(num * 100).toFixed(2)}%`;
};
```

## 9. 扩展性设计

### 9.1 多代币支持

```mermaid
graph TB
    subgraph "当前架构"
        A[单一代币池]
        B[固定利率]
        C[简单抵押]
    end
    
    subgraph "扩展架构"
        D[多代币池]
        E[动态利率]
        F[多重抵押]
        G[流动性挖矿]
    end
    
    A --> D
    B --> E
    C --> F
    D --> G
```

### 9.2 功能扩展点

```typescript
// 扩展接口设计
interface ExtendedLendingPool {
  // 多代币支持
  supportedTokens: string[];
  
  // 动态利率
  calculateInterestRate(utilization: number): number;
  
  // 清算机制
  liquidate(user: string, amount: number): Promise<void>;
  
  // 治理功能
  updateParameters(params: PoolParameters): Promise<void>;
}
```

## 10. 性能优化

### 10.1 数据缓存

```typescript
// 缓存机制
const useDataCache = () => {
  const [cache, setCache] = useState<Map<string, any>>(new Map());
  
  const getCachedData = (key: string, fetcher: () => Promise<any>) => {
    if (cache.has(key)) {
      return cache.get(key);
    }
    
    return fetcher().then(data => {
      setCache(prev => new Map(prev).set(key, data));
      return data;
    });
  };
  
  return { getCachedData };
};
```

### 10.2 批量操作

```typescript
// 批量数据获取
const fetchAllLendingData = async () => {
  const [userInfo, balance, rate] = await Promise.all([
    lendingContract.getUserInfo(account),
    tokenContract.balanceOf(account),
    lendingContract.interestRate()
  ]);
  
  return { userInfo, balance, rate };
};
```

---

## 总结

借贷功能通过以下核心组件实现：

1. **智能合约层**：LendingPool.sol 提供核心借贷逻辑
2. **前端组件**：LendingInterface.tsx 提供用户交互界面
3. **Web3集成**：通过 ethers.js 与区块链交互
4. **安全机制**：多重安全保护和验证
5. **用户体验**：响应式设计和状态管理

该系统支持存款、借款、还款、提款等完整的借贷功能，具有良好的安全性和扩展性。